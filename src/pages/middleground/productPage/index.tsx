import React, { useState } from 'react'
import { Icon } from '@/components'
import Title from '../controlPanel/components/title'
import { Form, Col, Row, Table, Input, Modal, Button } from 'antd'
import FormNode from '@/components/FormNode'
import { useHistory } from 'react-router'
import styles from './index.module.less'
import { cloneDeep } from 'lodash'
import { useStores, observer } from '@/utils/mobx'

const FormItem = Form.Item
const { TextArea } = Input

const keys = [
  'type',
  'options',
  'keys',
  'maxImgs',
  'maxSize',
  'tips',
  'placeholder',
  'disabled',
  'max',
  'min'
]

const TabelTitle = props => {
  const { title, callback } = props
  const addClick = () => {
    callback && callback()
  }

  return (
    <div className={styles.tableTitle}>
      {title ? title : null}
      <Icon
        type={'jack-del'}
        onClick={addClick}
        className={styles.tableIcon}
      ></Icon>
    </div>
  )
}

const RequiredTitle = props => {
  const { title } = props

  return <div className={styles.requiredTitle}>{title}</div>
}

const productModalTexts = new Map()
productModalTexts.set('color', { title: 'Ê∑ªÂä†È¢úËâ≤', label: 'È¢úËâ≤' })
productModalTexts.set('size', { title: 'Ê∑ªÂä†Â∞∫ÂØ∏', label: 'Â∞∫ÂØ∏' })

const ProductPage = props => {
  const { title = 'Êñ∞Â¢ûÂïÜÂìÅ' } = props
  const [form] = Form.useForm()
  const history = useHistory()

  const { orderStore } = useStores()
  const { productInfo } = orderStore

  const [productData, setProductData] = useState([])
  const [productModal, setProductModal] = useState(false)
  const [productModalType, setProductModalType] = useState('color')
  const [productModalValue, setProductModalValue] = useState('')
  const [productDataError, setProductDataError] = useState(false)

  const productConfigs = [
    {
      label: 'ÂïÜÂìÅÂêçÁß∞',
      required: true,
      message: 'ËØ∑ËæìÂÖ•ÂïÜÂìÅÂêçÁß∞',
      placeholder: 'ËØ∑ËæìÂÖ•ÂïÜÂìÅÂêçÁß∞',
      field: 'name',
      span: 12
    },
    {
      label: 'ÂïÜÂìÅÂìÅÁ±ª',
      required: true,
      message: 'ËØ∑ÈÄâÊã©ÂïÜÂìÅÂìÅÁ±ª',
      placeholder: 'ËØ∑ÈÄâÊã©ÂïÜÂìÅÂìÅÁ±ª',
      type: 'select',
      options: [
        { label: 'ÂìÅÁ±ª‰∏Ä', value: 1 },
        { label: 'ÂìÅÁ±ª‰∫å', value: 2 }
      ],
      field: 'goodsCategoryId',
      span: 12
    },
    {
      label: 'SPUÁºñÁ†Å',
      placeholder: 'ËØ∑ËæìÂÖ•SPUÁºñÁ†Å',
      field: 'spuCode',
      span: 12
    },
    {
      label: 'Áîü‰∫ßÊñπÂºè',
      required: true,
      message: 'ËØ∑ÈÄâÊã©Áîü‰∫ßÊñπÂºè',
      placeholder: 'ËØ∑ÈÄâÊã©Áîü‰∫ßÊñπÂºè',
      type: 'select',
      options: [
        { label: 'ÊñπÂºè‰∏Ä', value: 1 },
        { label: 'ÊñπÂºè‰∫å', value: 2 }
      ],
      field: 'procedureType',
      span: 12
    }
  ]

  const otherConfigs = [
    {
      label: 'Ê¨æÂõæ',
      field: 'imgs',
      maxImgs: 10,
      required: true,
      accept: '.jpg,.png,.jpeg',
      message: 'ËØ∑‰∏ä‰º†Ê¨æÂõæ',
      maxSize: 500,
      span: 20,
      type: 'img',
      tips: '‰∏ä‰º†Ê¨æÂõæÔºåÂè™ËÉΩ‰∏ä‰º†jpg/pngÊ†ºÂºèÊñá‰ª∂ÔºåÊñá‰ª∂‰∏çËÉΩË∂ÖËøá20MÔºåÊúÄÂ§ö‰∏ä‰º†10‰∏™Êñá‰ª∂'
    },
    {
      label: 'ÈôÑ‰ª∂',
      type: 'annex',
      field: 'annex',
      maxSize: 20,
      span: 20,
      accept: '.jpg,.png,.jpeg,.rar,.zip,.doc,.docx,.pdf',
      tips: 'ÊîØÊåÅÊâ©Â±ïÂêçÔºö.rar .zip .doc .docx .pdf .jpg...'
    },
    {
      label: 'Â§áÊ≥®ËØ¥Êòé',
      type: 'textarea',
      field: 'remark',
      rows: 4,
      span: 20
    }
  ]

  const layout = {
    labelCol: {
      span: 5
    },
    wrapperCol: {
      span: 12
    }
  }

  const layout2 = {
    labelCol: {
      span: 3
    },
    wrapperCol: {
      span: 17
    }
  }

  const valuesChange = _values => {
    // const keys = Reflect.ownKeys(values)
  }

  const backToOrder = () => {
    history.goBack()
  }

  const productValuesChange = (event, field, index) => {
    const targetData = cloneDeep(productData)
    targetData[index][field] = event.target.value
    setProductData(targetData)
  }

  const productColumns: any = [
    {
      title: 'SKUÁºñÂè∑',
      align: 'center',
      dataIndex: 'skuCode',
      width: 210,
      render: (val, row, idx) => (
        <Input
          placeholder={'ËØ∑ËæìÂÖ•SKUÁºñÂè∑'}
          value={val}
          onChange={event => productValuesChange(event, 'skuCode', idx)}
        ></Input>
      )
    },
    {
      title: (
        <TabelTitle
          title={'È¢úËâ≤'}
          callback={() => showProductModal('color')}
        ></TabelTitle>
      ),
      align: 'center',
      dataIndex: 'color',
      width: 210,
      render: (val, row, idx) => (
        <Input
          placeholder={'ËØ∑ËæìÂÖ•È¢úËâ≤'}
          value={val}
          onChange={event => productValuesChange(event, 'color', idx)}
        ></Input>
      )
    },
    {
      title: (
        <TabelTitle
          title={'Â∞∫ÂØ∏'}
          callback={() => showProductModal('size')}
        ></TabelTitle>
      ),
      align: 'center',
      dataIndex: 'size',
      width: 210,
      render: (val, row, idx) => (
        <Input
          placeholder={'ËØ∑ËæìÂÖ•Â∞∫ÂØ∏'}
          value={val}
          onChange={event => productValuesChange(event, 'size', idx)}
        ></Input>
      )
    },
    {
      title: <RequiredTitle title={'Êï∞Èáè(‰ª∂)'}></RequiredTitle>,
      align: 'center',
      dataIndex: 'count',
      width: 210,
      render: (val, row, idx) => (
        <Input
          placeholder={'ËØ∑ËæìÂÖ•Êï∞Èáè'}
          value={val}
          onChange={event => productValuesChange(event, 'count', idx)}
        ></Input>
      )
    },
    {
      title: <RequiredTitle title={'Âçï‰ª∑'}></RequiredTitle>,
      align: 'center',
      dataIndex: 'amount',
      width: 210,
      render: (val, row, idx) => (
        <Input
          placeholder={'ËØ∑ËæìÂÖ•Âçï‰ª∑'}
          value={val}
          onChange={event => productValuesChange(event, 'amount', idx)}
        ></Input>
      )
    },
    {
      title: <TabelTitle callback={() => showProductModal('add')} />,
      align: 'center',
      dataIndex: 'edit',
      render: (val, row, idx) => (
        <Icon
          type={'jack-del-icon'}
          className={styles.delIcon}
          onClick={() => delProduct(idx)}
        ></Icon>
      )
    }
  ]

  const showProductModal = type => {
    if (type === 'add') {
      const dataList = cloneDeep(productData)
      const target =
        dataList.length > 0 ? cloneDeep(dataList[dataList.length - 1]) : {}
      target[productModalType] = productModalValue
      const res = [].concat(dataList, target)
      setProductData(res)
      return
    }

    setProductModal(f => !f)
    type && setProductModalType(type)
  }

  const delProduct = index => {
    const targetList = productData.filter((_item, idx) => idx !== index)
    setProductData(targetList)
  }

  const productModalValueChange = event => {
    const { value } = event.target
    setProductModalValue(value)
  }

  const productModalSubmit = () => {
    const dataList = cloneDeep(productData)
    const target =
      dataList.length > 0 ? cloneDeep(dataList[dataList.length - 1]) : {}
    target[productModalType] = productModalValue
    target['skuCode'] = ''
    target['count'] = ''
    target['amount'] = ''
    const res = [].concat(dataList, target)
    setProductData(res)
    setProductModal(f => !f)
  }

  const submitClick = async () => {
    try {
      const values = await form.validateFields()
      console.log(
        'üöÄ ~ file: index.tsx ~ line 284 ~ saveProduct ~ values',
        values
      )
      const flag = productData.every(item => {
        return item.count > 0 && item.amount > 0
      })
      setProductDataError(flag)
    } catch (err) {
      console.log(err)
    }
  }

  return (
    <div className={styles.productPage}>
      {productModal ? (
        <Modal
          visible={productModal}
          centered
          maskClosable={false}
          onCancel={showProductModal}
          title={false}
          footer={false}
        >
          <Title
            title={productModalTexts.get(productModalType).title}
            size={18}
          ></Title>
          <div className={styles.productModalContent}>
            <span className={styles.label}>
              {productModalTexts.get(productModalType).label}
            </span>
            <TextArea rows={4} onChange={productModalValueChange}></TextArea>
          </div>
          <div className={styles.productModalBtns}>
            <Button
              type={'primary'}
              ghost
              className={styles.tableModalBtn}
              onClick={showProductModal}
            >
              ÂèñÊ∂à
            </Button>
            <Button
              type={'primary'}
              className={styles.tableModalBtn}
              onClick={productModalSubmit}
            >
              Á°ÆÂÆö
            </Button>
          </div>
        </Modal>
      ) : null}

      <Form
        form={form}
        labelAlign={'left'}
        colon={false}
        onValuesChange={valuesChange}
        scrollToFirstError={true}
        onFinish={submitClick}
      >
        <div className={styles.header}>
          <Icon
            onClick={backToOrder}
            type={'jack-left-copy'}
            className={styles.headerIcon}
          ></Icon>
          {title}
        </div>

        <section className={styles.productSection}>
          <Title title={'ÂïÜÂìÅ‰ø°ÊÅØ'}></Title>
          <Row className={styles.row}>
            {productConfigs.map(item => {
              const data: any = {}
              keys.forEach(i => {
                if (![null, undefined].includes(item[i])) {
                  data[i] = item[i]
                }
              })

              return (
                <Col key={item.field} span={item.span}>
                  <FormItem
                    name={item.field}
                    label={item.label}
                    rules={[{ required: item.required, message: item.message }]}
                    {...layout}
                  >
                    <FormNode {...data}></FormNode>
                  </FormItem>
                </Col>
              )
            })}
          </Row>
        </section>

        <section className={styles.productSection}>
          <Title title={'ÂïÜÂìÅËßÑÊ†º'}></Title>
          <Table
            pagination={false}
            columns={productColumns}
            dataSource={productData}
          ></Table>

          {productDataError ? (
            <div>ËØ∑Ê£ÄÊü•ËæìÂÖ•ÁöÑÂïÜÂìÅËßÑÂÜÖÂÆπÔºå ÊúÄÂ∞ë‰∏ÄÊù°Êï∞ÊçÆ</div>
          ) : null}
        </section>

        <section className={styles.productSection}>
          <Title title={'Áâ©Êñô‰ø°ÊÅØ'}></Title>
        </section>

        <section className={styles.productSection}>
          <Title title={'ÂÖ∂ÂÆÉ'}></Title>
          <Row className={styles.row}>
            {otherConfigs.map(item => {
              const data: any = {}
              keys.forEach(i => {
                if (![null, undefined].includes(item[i])) {
                  data[i] = item[i]
                }
              })

              return (
                <Col key={item.field} span={item.span}>
                  <FormItem
                    name={item.field}
                    label={item.label}
                    rules={[{ required: item.required, message: item.message }]}
                    {...layout2}
                  >
                    <FormNode {...data}></FormNode>
                  </FormItem>
                </Col>
              )
            })}
          </Row>
        </section>

        <Button type={'primary'} className={styles.saveBtn} htmlType={'submit'}>
          ‰øùÂ≠òÂïÜÂìÅ
        </Button>
      </Form>
    </div>
  )
}

export default observer(ProductPage)
